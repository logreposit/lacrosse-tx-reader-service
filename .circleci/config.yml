version: 2.1


orbs:
  codecov: codecov/codecov@1.1.1


jobs:
  build:
    resource_class: medium
    docker:
      - image: cimg/base:stable-20.04
    steps:
      - checkout
      - attach_workspace:
          at: /home/circleci/
      - setup_remote_docker:
          version: 18.09.3
      - run:
          name: Build
          command: |
            version=$(git describe)
            docker_image_tag="logreposit/lacrosse-tx-reader-service:${version}"
            echo "Building docker image ${docker_image_tag} ..."
            export DOCKER_CLI_EXPERIMENTAL=enabled

            #docker buildx create --use --name mybuild node-amd64 mybuild
            #docker buildx create --append --name mybuild node-arm64
            #docker buildx build --platform linux/amd64,linux/arm64 .
            #docker buildx create --use

            #docker buildx create --name mybuilder
            #docker buildx use mybuilder

            docker context create builder
            docker buildx create builder --use

            docker context ls
            ls /proc/sys/fs/binfmt_misc/

            docker buildx ls

            docker buildx build \
              --platform linux/arm/v7,linux/arm64/v8,linux/amd64 \
              --tag ${docker_image_tag} \
              --push .

            echo "Successfully built image ${docker_image_tag}"
      - run:
          name: Saving docker image
          command: |
            version=$(git describe)
            docker_image_tag="logreposit/lacrosse-tx-reader-service:${version}"
            mkdir ~/docker-images/
            docker save ${docker_image_tag} > ~/docker-images/app.tar
      - persist_to_workspace:
          root: /home/circleci/
          paths:
            - project/*
            - docker-images/*


  push:
    resource_class: small
    docker:
      - image: cimg/base:stable-18.04
    steps:
      - attach_workspace:
          at: /home/circleci/
      - setup_remote_docker
      - run:
          name: Loading docker image
          command: |
            docker load < ~/docker-images/app.tar
      - run:
          name: Push
          command: |
            version=$(git describe)
            docker_image_tag="logreposit/lacrosse-tx-reader-service:${version}"
            echo ${LOGREPOSIT_DOCKERHUB_PASSWORD} | docker login -u ${LOGREPOSIT_DOCKERHUB_USERNAME} --password-stdin
            docker push ${docker_image_tag}
            echo "Successfully pushed image ${docker_image_tag}"


workflows:
  base-workflow:
    jobs:
      - build:
          context: logreposit

      - push:
          context: logreposit
          requires:
            - build
